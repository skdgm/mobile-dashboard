<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK MOBILE PORTAL</title>
    <link rel="icon" type="image/x-icon" href="https://skmobile.in/favicon.ico">
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F5F5;
            transition: all 0.3s ease-in-out;
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Hide scrollbar for select elements on some browsers */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23D90429" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%, 0 0;
            background-size: 1.5em auto, 100%;
        }
        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
            box-shadow: 0 0 5px 2px;
        }
        .status-dot.connecting {
            background-color: #3B82F6; /* Blue */
            box-shadow: 0 0 5px 2px rgba(59, 130, 246, 0.7);
        }
        .status-dot.connected {
            background-color: #10B981; /* Green */
            box-shadow: 0 0 5px 2px rgba(16, 185, 129, 0.7);
        }
        .status-dot.disconnected {
            background-color: #EF4444; /* Red */
            box-shadow: 0 0 5px 2px rgba(239, 68, 68, 0.7);
        }
        .dropdown-container {
            position: relative;
        }
        .loading-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            z-index: 10;
        }
        .loading-bar-container {
            height: 4px;
            background-color: #E5E7EB;
            border-radius: 2px;
            overflow: hidden;
            width: 90%;
            margin: 0 auto;
        }
        .loading-bar {
            height: 100%;
            background-color: #D90429;
            animation: move-bar 1.5s infinite linear;
        }
        @keyframes move-bar {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header for Logo -->
    <header id="logo-header" class="w-full bg-white shadow-lg p-2 transition-all duration-300">
        <div class="max-w-7xl mx-auto flex justify-center items-center px-4">
            <img src="https://skmobile.in/wp-content/uploads/2024/01/skweblogo.webp" alt="SK Mobile Logo" class="w-auto h-auto max-h-12 max-w-[200px] transition-transform duration-300 hover:scale-110">
        </div>
    </header>

    <!-- App Header -->
    <header id="app-header" class="w-full bg-white shadow-md p-4 transition-all duration-300 hidden">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-start sm:items-center px-4">
            <div class="flex flex-col mb-2 sm:mb-0">
                <h1 class="text-xl sm:text-2xl font-extrabold text-[#4A4A4A]">SK MOBILE PORTAL</h1>
                <p class="text-xs sm:text-sm text-gray-500">Price Checker</p>
            </div>
            <div class="flex flex-row items-center space-x-2">
                <span id="user-info" class="text-sm font-semibold text-gray-700"></span>
                <button id="logout-button" class="px-3 py-1 text-sm text-[#D90429] border border-[#D90429] rounded-full hover:bg-[#B70023] hover:text-white transition duration-300 flex items-center justify-center">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <span class="hidden sm:inline ml-1">Logout</span>
                </button>
            </div>
        </div>
    </header>


    <!-- Login Container -->
    <div id="login-container" class="flex items-center justify-center min-h-screen p-4 pt-8">
        <div class="bg-white p-6 sm:p-8 md:p-10 rounded-3xl shadow-2xl w-full max-w-sm sm:max-w-md text-center animate-fadeIn text-[#4A4A4A]">
            <!-- Login Content -->
            <h1 class="text-3xl sm:text-4xl font-extrabold text-[#4A4A4A] mb-2">SK MOBILE PORTAL</h1>
            <p class="text-sm text-gray-500 mb-8">Login to view product prices and margins.</p>
            <form id="login-form" class="space-y-6">
                <input type="email" id="email" class="w-full px-5 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#D90429] transition-colors duration-200 bg-white text-[#4A4A4A]" placeholder="Email" required>
                <input type="password" id="password" class="w-full px-5 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#D90429] transition-colors duration-200 bg-white text-[#4A4A4A]" placeholder="Password" required>
                <p id="error-message" class="text-sm text-[#D90429] hidden"></p>
                <button type="submit" class="w-full bg-[#D90429] text-white py-4 rounded-xl font-bold hover:bg-[#B70023] transition duration-300 transform hover:scale-105 shadow-lg">Login</button>
            </form>
            <div class="mt-4 flex items-center justify-center text-sm text-gray-500">
                Server Status: <span id="server-status-dot" class="status-dot connecting"></span>
            </div>
        </div>
    </div>

    <!-- Main App Container (Initially hidden) -->
    <div id="app-container" class="hidden w-full max-w-5xl mx-auto p-4 sm:p-6 md:p-8 mt-4">
        
        <!-- Filters Section -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-lg font-bold text-[#4A4A4A] mb-4">Product Selection</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="dropdown-container">
                    <label for="category-select" class="block text-sm font-semibold text-gray-700 mb-2">1. Select Category</label>
                    <div id="category-loading-overlay" class="loading-overlay hidden">
                        <div class="loading-bar-container">
                            <div class="loading-bar"></div>
                        </div>
                    </div>
                    <select id="category-select" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#D90429] cursor-pointer bg-white text-[#4A4A4A] transition-shadow duration-200 shadow-sm" disabled>
                        <option value="" disabled selected>Select Category</option>
                    </select>
                </div>
                <div class="dropdown-container">
                    <label for="brand-select" class="block text-sm font-semibold text-gray-700 mb-2">2. Select Brand</label>
                    <div id="brand-loading-overlay" class="loading-overlay hidden">
                        <div class="loading-bar-container">
                            <div class="loading-bar"></div>
                        </div>
                    </div>
                    <select id="brand-select" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#D90429] cursor-pointer bg-white text-[#4A4A4A] transition-shadow duration-200 shadow-sm" disabled>
                        <option value="" disabled selected>Please select a Category first</option>
                    </select>
                </div>
                <div class="dropdown-container">
                    <label for="model-select" class="block text-sm font-semibold text-gray-700 mb-2">3. Select Model</label>
                    <div id="model-loading-overlay" class="loading-overlay hidden">
                        <div class="loading-bar-container">
                            <div class="loading-bar"></div>
                        </div>
                    </div>
                    <select id="model-select" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#D90429] cursor-pointer bg-white text-[#4A4A4A] transition-shadow duration-200 shadow-sm" disabled>
                        <option value="" disabled selected>Please select a Brand first</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Details Display -->
        <div id="details-container" class="hidden">
            <div class="space-y-6">
                <!-- Selling Price Card -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-[#D90429]">
                    <h2 class="text-lg font-bold text-[#4A4A4A] mb-2">MOP</h2>
                    <p id="selling-price" class="text-4xl sm:text-5xl font-extrabold text-[#D90429] whitespace-nowrap overflow-hidden text-ellipsis"></p>
                </div>

                <!-- Other Details Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-[#4A4A4A]">
                        <span class="text-sm font-medium text-gray-500 block mb-1">NLC (Net Landed Cost):</span>
                        <p id="nlc" class="text-xl sm:text-2xl font-semibold"></p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-[#4A4A4A]">
                        <span class="text-sm font-medium text-gray-500 block mb-1">Margin:</span>
                        <p id="margin" class="text-xl sm:text-2xl font-semibold"></p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-[#4A4A4A]">
                        <span class="text-sm font-medium text-gray-500 block mb-1">Margin %:</span>
                        <p id="margin-percent" class="text-xl sm:text-2xl font-semibold"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <p id="result-message" class="text-center text-sm text-[#D90429] mt-6 hidden"></p>
    </div>

    <!-- Footer Text -->
    <div class="fixed bottom-4 right-4 text-xs text-gray-500">
        S.K. INFINITRADE PVT LTD.
    </div>

    <script>
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbwjq3Iv2A2IuY2VQW3ZWOGaQwwBLWemo-mv1Wnl8iGrZb6JLYEUXhQktqpoMlNVmp7A4A/exec'; // *** IMPORTANT: PASTE YOUR DEPLOYED APPS SCRIPT URL HERE. It needs to be a valid URL with a trailing slash for some fetch requests. ***

        // --- DOM Elements ---
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('error-message');
        const serverStatusDot = document.getElementById('server-status-dot');
        const appContainer = document.getElementById('app-container');
        const logoutButton = document.getElementById('logout-button');
        const userInfoSpan = document.getElementById('user-info');
        const categorySelect = document.getElementById('category-select');
        const brandSelect = document.getElementById('brand-select');
        const modelSelect = document.getElementById('model-select');
        const categoryLoadingOverlay = document.getElementById('category-loading-overlay');
        const brandLoadingOverlay = document.getElementById('brand-loading-overlay');
        const modelLoadingOverlay = document.getElementById('model-loading-overlay');
        const detailsContainer = document.getElementById('details-container');
        const sellingPriceSpan = document.getElementById('selling-price');
        const nlcSpan = document.getElementById('nlc');
        const marginSpan = document.getElementById('margin');
        const marginPercentSpan = document.getElementById('margin-percent');
        const resultMessage = document.getElementById('result-message');
        const logoHeader = document.getElementById('logo-header');
        const appHeader = document.getElementById('app-header');

        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        categorySelect.addEventListener('change', () => {
            fetchBrands(categorySelect.value);
            populateDropdown(modelSelect, [], 'Please select a Brand first');
        });
        brandSelect.addEventListener('change', () => fetchModels(categorySelect.value, brandSelect.value));
        modelSelect.addEventListener('change', () => fetchDetails(categorySelect.value, brandSelect.value, modelSelect.value));
        
        window.onload = checkSession;

        // --- Functions ---
        async function checkServerStatus() {
            try {
                const response = await fetch(`${scriptUrl}?type=status`);
                if (response.ok) {
                    serverStatusDot.classList.remove('connecting', 'disconnected');
                    serverStatusDot.classList.add('connected');
                } else {
                    serverStatusDot.classList.remove('connecting', 'connected');
                    serverStatusDot.classList.add('disconnected');
                }
            } catch (error) {
                serverStatusDot.classList.remove('connecting', 'connected');
                serverStatusDot.classList.add('disconnected');
            }
        }

        function checkSession() {
            checkServerStatus();
            if (localStorage.getItem('isLoggedIn') === 'true') {
                showAppUI();
                fetchCategories();
                displayUserInfo();
            } else {
                showLoginUI();
            }
        }
        
        function showLoginUI() {
            loginContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            logoHeader.classList.remove('hidden'); 
            appHeader.classList.add('hidden');
        }

        function showAppUI() {
            loginContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            logoHeader.classList.remove('hidden'); 
            appHeader.classList.remove('hidden');
        }

        async function handleLogin(e) {
            e.preventDefault();
            errorMessage.classList.add('hidden');
            serverStatusDot.classList.remove('connected', 'disconnected');
            serverStatusDot.classList.add('connecting');

            const email = emailInput.value;
            const password = passwordInput.value;
            const url = `${scriptUrl}?type=checkLogin&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`;
            
            showAppLoading();

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Server returned status: ${response.status}`);
                }
                const data = await response.json();
                hideAppLoading();
                checkServerStatus();

                if (data.success) {
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userEmail', email); // Store the user email
                    showAppUI();
                    fetchCategories();
                    displayUserInfo();
                } else {
                    errorMessage.textContent = 'Invalid email or password. Please check your credentials.';
                    errorMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                hideAppLoading();
                checkServerStatus();
                errorMessage.textContent = 'Failed to connect to the server. Please check your internet connection or the Apps Script URL.';
                errorMessage.classList.remove('hidden');
            }
        }

        function handleLogout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userEmail'); // Clear the email
            showLoginUI();
            loginForm.reset();
            // Reset app state
            populateDropdown(categorySelect, [], 'Select Category');
            populateDropdown(brandSelect, [], 'Please select a Category first');
            populateDropdown(modelSelect, [], 'Please select a Brand first');
            categorySelect.disabled = true;
            brandSelect.disabled = true;
            modelSelect.disabled = true;
            detailsContainer.classList.add('hidden');
            resultMessage.classList.add('hidden');
            checkServerStatus();
        }

        function displayUserInfo() {
            const userEmail = localStorage.getItem('userEmail');
            if (userEmail) {
                let displayName = userEmail;
                const pattern = '.skpvtltd@gmail.com';
                if (userEmail.endsWith(pattern)) {
                    displayName = userEmail.substring(0, userEmail.length - pattern.length);
                }
                userInfoSpan.textContent = `Hello, ${displayName}!`;
            }
        }

        async function fetchCategories() {
            toggleLoading(categorySelect, true);
            const url = `${scriptUrl}?type=categories`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                populateDropdown(categorySelect, data, "Select Category");
            } catch (error) {
                console.error('Error fetching categories:', error);
            } finally {
                toggleLoading(categorySelect, false);
            }
        }

        async function fetchBrands(category) {
            detailsContainer.classList.add('hidden');
            resultMessage.classList.add('hidden');
            toggleLoading(brandSelect, true);
            
            const url = `${scriptUrl}?type=brands&category=${encodeURIComponent(category)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                populateDropdown(brandSelect, data, "Select Brand");
                populateDropdown(modelSelect, [], 'Please select a Brand first');
            } catch (error) {
                console.error('Error fetching brands:', error);
            } finally {
                toggleLoading(brandSelect, false);
            }
        }

        async function fetchModels(category, brand) {
            detailsContainer.classList.add('hidden');
            resultMessage.classList.add('hidden');
            toggleLoading(modelSelect, true);
            
            const url = `${scriptUrl}?type=models&category=${encodeURIComponent(category)}&brand=${encodeURIComponent(brand)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                populateDropdown(modelSelect, data, "Select Model");
            } catch (error) {
                console.error('Error fetching models:', error);
            } finally {
                toggleLoading(modelSelect, false);
            }
        }

        async function fetchDetails(category, brand, model) {
            const url = `${scriptUrl}?type=details&category=${encodeURIComponent(category)}&brand=${encodeURIComponent(brand)}&model=${encodeURIComponent(model)}`;
            showAppLoading();
            try {
                const response = await fetch(url);
                const data = await response.json();
                hideAppLoading();
                if (data.error) {
                    detailsContainer.classList.add('hidden');
                    resultMessage.textContent = data.error;
                    resultMessage.classList.remove('hidden');
                } else {
                    displayDetails(data);
                    resultMessage.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching details:', error);
                hideAppLoading();
                detailsContainer.classList.add('hidden');
                resultMessage.textContent = 'An error occurred while fetching details.';
                resultMessage.classList.remove('hidden');
                }
        }
        
        function populateDropdown(selectElement, items, placeholderText) {
            selectElement.innerHTML = `<option value="" disabled selected>${placeholderText}</option>`;
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                selectElement.appendChild(option);
            });
        }
        
        function toggleLoading(selectElement, isLoading) {
            const overlay = document.getElementById(selectElement.id.replace('-select', '-loading-overlay'));
            if (isLoading) {
                overlay.classList.remove('hidden');
                selectElement.disabled = true;
            } else {
                overlay.classList.add('hidden');
                selectElement.disabled = false;
            }
        }

        function displayDetails(details) {
            const formatNumber = (num) => parseFloat(num).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            // Adjust font size based on the length of the formatted number
            const formattedPrice = `₹ ${formatNumber(details.SellingPrice)}`;
            const priceElement = document.getElementById('selling-price');
            priceElement.textContent = formattedPrice;

            if (formattedPrice.length > 12) {
                priceElement.classList.remove('sm:text-5xl');
                priceElement.classList.add('sm:text-4xl');
            } else {
                priceElement.classList.remove('sm:text-4xl');
                priceElement.classList.add('sm:text-5xl');
            }

            nlcSpan.textContent = `₹ ${formatNumber(details.NLC)}`;
            marginSpan.textContent = `₹ ${formatNumber(details.Margin)}`;
            marginPercentSpan.textContent = details.MarginPercent;
            detailsContainer.classList.remove('hidden');
            resultMessage.classList.add('hidden');
        }

        // Full-page spinner functions, kept for login/logout
        function showAppLoading() {
            document.body.classList.add('overflow-hidden');
            const spinner = document.createElement('div');
            spinner.id = 'loading';
            spinner.className = 'fixed inset-0 bg-gray-500 bg-opacity-50 z-50 flex items-center justify-center';
            spinner.innerHTML = `<svg class="animate-spin h-10 w-10 text-[#D90429]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            document.body.appendChild(spinner);
        }

        function hideAppLoading() {
            document.body.classList.remove('overflow-hidden');
            const spinner = document.getElementById('loading');
            if (spinner) {
                spinner.remove();
            }
        }
    </script>
</body>
</html>
