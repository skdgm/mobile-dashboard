<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Price Checker</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: all 0.3s ease-in-out;
        }
        .container {
            max-width: 90%;
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Hide scrollbar for select elements on some browsers */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="black" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%, 0 0;
            background-size: 1.5em auto, 100%;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Loading Spinner -->
    <div id="loading" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Login Container -->
    <div id="login-container" class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center animate-fadeIn">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">Store Price Checker</h1>
        <form id="login-form" class="space-y-4">
            <input type="email" id="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Email" required>
            <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Password" required>
            <p id="error-message" class="text-sm text-red-500 hidden"></p>
            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Login</button>
        </form>
    </div>

    <!-- Main App Container (Initially hidden) -->
    <div id="app-container" class="hidden bg-white p-8 rounded-2xl shadow-2xl w-full max-w-4xl animate-fadeIn">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Price Details</h1>
            <button id="logout-button" class="text-sm text-blue-600 hover:text-blue-800 transition duration-300">Logout</button>
        </div>
        
        <!-- Filters Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div>
                <label for="category-select" class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                <select id="category-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer bg-white">
                    <option value="" disabled selected>Select Category</option>
                </select>
            </div>
            <div>
                <label for="brand-select" class="block text-sm font-medium text-gray-700 mb-2">Brand</label>
                <select id="brand-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer bg-white" disabled>
                    <option value="" disabled selected>Select Brand</option>
                </select>
            </div>
            <div>
                <label for="model-select" class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                <select id="model-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer bg-white" disabled>
                    <option value="" disabled selected>Select Model</option>
                </select>
            </div>
        </div>

        <!-- Details Display -->
        <div id="details-container" class="hidden">
            <div class="space-y-4">
                <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg">
                    <span class="font-medium text-gray-600">Selling Price:</span>
                    <span id="selling-price" class="text-2xl font-bold text-blue-600"></span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <span class="font-medium text-gray-600">NLC:</span>
                        <p id="nlc" class="text-xl font-semibold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <span class="font-medium text-gray-600">Margin:</span>
                        <p id="margin" class="text-xl font-semibold text-gray-800"></p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <span class="font-medium text-gray-600">Margin %:</span>
                        <p id="margin-percent" class="text-xl font-semibold text-gray-800"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <p id="result-message" class="text-center text-sm text-gray-500 mt-6 hidden"></p>
    </div>

    <script>
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbyg4tWBEVgz84DEJ0Kjs6fVlbTFHugK-9g3eB8KX_5KOXnv6xYlKnL4mJdwJJkeU-lQKg/exec'; // *** IMPORTANT: PASTE YOUR DEPLOYED APPS SCRIPT URL HERE ***

        // --- DOM Elements ---
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('error-message');
        const appContainer = document.getElementById('app-container');
        const logoutButton = document.getElementById('logout-button');
        const categorySelect = document.getElementById('category-select');
        const brandSelect = document.getElementById('brand-select');
        const modelSelect = document.getElementById('model-select');
        const detailsContainer = document.getElementById('details-container');
        const sellingPriceSpan = document.getElementById('selling-price');
        const nlcSpan = document.getElementById('nlc');
        const marginSpan = document.getElementById('margin');
        const marginPercentSpan = document.getElementById('margin-percent');
        const resultMessage = document.getElementById('result-message');
        const loadingSpinner = document.getElementById('loading');

        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        categorySelect.addEventListener('change', () => fetchBrands(categorySelect.value));
        brandSelect.addEventListener('change', () => fetchModels(categorySelect.value, brandSelect.value));
        modelSelect.addEventListener('change', () => fetchDetails(categorySelect.value, brandSelect.value, modelSelect.value));
        
        window.onload = checkSession;

        // --- Functions ---

        function checkSession() {
            if (localStorage.getItem('isLoggedIn') === 'true') {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                fetchCategories();
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            showLoading();
            errorMessage.classList.add('hidden');

            const email = emailInput.value;
            const password = passwordInput.value;
            const url = `${scriptUrl}?type=checkLogin&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                hideLoading();

                if (data.success) {
                    localStorage.setItem('isLoggedIn', 'true');
                    loginContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    fetchCategories();
                } else {
                    errorMessage.textContent = 'Invalid email or password.';
                    errorMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                hideLoading();
                errorMessage.textContent = 'An error occurred. Please try again later.';
                errorMessage.classList.remove('hidden');
            }
        }

        function handleLogout() {
            localStorage.removeItem('isLoggedIn');
            appContainer.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            loginForm.reset();
            // Reset app state
            categorySelect.innerHTML = '<option value="" disabled selected>Select Category</option>';
            brandSelect.innerHTML = '<option value="" disabled selected>Select Brand</option>';
            modelSelect.innerHTML = '<option value="" disabled selected>Select Model</option>';
            brandSelect.disabled = true;
            modelSelect.disabled = true;
            detailsContainer.classList.add('hidden');
            resultMessage.classList.add('hidden');
        }

        async function fetchCategories() {
            showLoading();
            const url = `${scriptUrl}?type=categories`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                populateDropdown(categorySelect, data, "Select Category");
                hideLoading();
            } catch (error) {
                console.error('Error fetching categories:', error);
                hideLoading();
            }
        }

        async function fetchBrands(category) {
            showLoading();
            modelSelect.innerHTML = '<option value="" disabled selected>Select Model</option>';
            detailsContainer.classList.add('hidden');
            resultMessage.classList.add('hidden');
            const url = `${scriptUrl}?type=brands&category=${encodeURIComponent(category)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                populateDropdown(brandSelect, data, "Select Brand");
                brandSelect.disabled = false;
                modelSelect.disabled = true;
                hideLoading();
            } catch (error) {
                console.error('Error fetching brands:', error);
                hideLoading();
            }
        }

        async function fetchModels(category, brand) {
            showLoading();
            detailsContainer.classList.add('hidden');
            resultMessage.classList.add('hidden');
            const url = `${scriptUrl}?type=models&category=${encodeURIComponent(category)}&brand=${encodeURIComponent(brand)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                populateDropdown(modelSelect, data, "Select Model");
                modelSelect.disabled = false;
                hideLoading();
            } catch (error) {
                console.error('Error fetching models:', error);
                hideLoading();
            }
        }

        async function fetchDetails(category, brand, model) {
            showLoading();
            const url = `${scriptUrl}?type=details&category=${encodeURIComponent(category)}&brand=${encodeURIComponent(brand)}&model=${encodeURIComponent(model)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                hideLoading();
                if (data.error) {
                    detailsContainer.classList.add('hidden');
                    resultMessage.textContent = data.error;
                    resultMessage.classList.remove('hidden');
                } else {
                    displayDetails(data);
                }
            } catch (error) {
                console.error('Error fetching details:', error);
                hideLoading();
                detailsContainer.classList.add('hidden');
                resultMessage.textContent = 'An error occurred while fetching details.';
                resultMessage.classList.remove('hidden');
            }
        }
        
        function populateDropdown(selectElement, items, placeholderText) {
            selectElement.innerHTML = `<option value="" disabled selected>${placeholderText}</option>`;
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                selectElement.appendChild(option);
            });
        }

        function displayDetails(details) {
            sellingPriceSpan.textContent = `₹ ${details.SellingPrice.toLocaleString('en-IN')}`;
            nlcSpan.textContent = `₹ ${details.NLC.toLocaleString('en-IN')}`;
            marginSpan.textContent = `₹ ${details.Margin.toLocaleString('en-IN')}`;
            marginPercentSpan.textContent = `${details.MarginPercent} %`;
            detailsContainer.classList.remove('hidden');
            resultMessage.classList.add('hidden');
        }
        
        function showLoading() {
            loadingSpinner.classList.remove('hidden');
        }

        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

    </script>
</body>
</html>
